<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Opening Library</title>
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD" crossorigin="anonymous"></script>
  <style>
    #board {
      width: 50vw;
    }
  </style>
</head>
<body>
  <div id="board"></div>
  <h1 id="eval"></h1>
  <script>
    $(document).ready(function() {
      var $board = $("#board");
      var whiteSquareGrey = "#a9a9a9";
      var blackSquareGrey = "#696969";
      var game = new Chess();

      async function compMove(fen) {
        try {
          return await(await fetch(`http://www.chessdb.cn/cdb.php?action=queryall&board=${encodeURIComponent(fen)}`)).text();
        } catch(error) {
          console.error("Error fetching data from Chess Cloud Database API", error);
        }
      }

      function removeGreySquares() {
        $("#board .square-55d63").css("background", "");
      }

      function greySquare(square) {
        /* White squares: .white-1e1d7
           Black squares: .black-3c85d
           All squares: .square-55d63 */
        var $square = $("#board .square-" + square);
        $square.css("background", $square.hasClass("black-3c85d") ? blackSquareGrey : whiteSquareGrey);
      }

      function onDragStart(source, piece) {
        if(game.game_over() || (game.turn() === "w" && piece.search(/^b/) !== -1) || (game.turn() === "b" && piece.search(/^w/) !== -1)) return false;
      }

      function onDrop(source, target) {
        removeGreySquares();
        if(game.move({from: source, to: target, promotion: "q"}) === null) return "snapback";
      }

      function onMouseoverSquare(square, piece) {
        var moves = game.moves({
          square: square,
          verbose: true
        });
        if(moves.length === 0) return;
        greySquare(square);
        for(var i = 0; i < moves.length; i++) greySquare(moves[i].to);
      }

      function onMouseoutSquare(square, piece) {
        removeGreySquares();
      }

      function onSnapEnd() {
        board.position(game.fen());
        compMove(game.fen()).then(function(result) {
          $("#eval").text("eval: " + -/score:([-+]?\d+)/.exec(result)[1]);
          var move = /move:([a-h][1-8][a-h][1-8])/.exec(result)[1];
          game.move({from: move.substring(0, 2), to: move.substring(2, 4), promotion: "q"});
          board.position(game.fen());
        });
      }

      var board = Chessboard("board", {
        draggable: true,
        position: "start",
        onDragStart: onDragStart,
        onDrop: onDrop,
        onMouseoutSquare: onMouseoutSquare,
        onMouseoverSquare: onMouseoverSquare,
        onSnapEnd: onSnapEnd
      });
    });
  </script>
</body>
</html>